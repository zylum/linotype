#!/usr/bin/env bash
set -euo pipefail

# LinoLoop: thin orchestration layer over Linotype executor briefs.
# - Target can be a single galley name OR a release id.
# - Release format: docs/work/releases/<release-id>/galleys.txt (one galley per line)
#
# Loop runner:
# - If `ralph` is available (open-ralph-wiggum), use it to run OpenCode repeatedly.
# - Otherwise, print the brief and exit (manual paste into OpenCode).

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
LINOTYPE=""
DOCS_DIR="$ROOT_DIR/docs"
WORK_DIR="$DOCS_DIR/work"
RELEASES_DIR="$WORK_DIR/releases"

DIST_DIR="$ROOT_DIR/dist"
LOCK_DIR="$DIST_DIR/linoloop/locks"
LOG_DIR="$DIST_DIR/linoloop/logs"

AGENT="${LINOLOOP_AGENT:-opencode}"
MAX_ITER="${LINOLOOP_MAX_ITER:-50}"
RUNNER="${LINOLOOP_RUNNER:-ralph}"

usage() {
  cat <<'USAGE'
LinoLoop

Usage:
  cli/linoloop <galley-name>
  cli/linoloop <release-id>

Release format:
  docs/work/releases/<release-id>/galleys.txt
  - one galley name per line
  - blank lines allowed
  - comment lines start with '#'

Environment:
  LINOLOOP_AGENT=opencode         # default: opencode
  LINOLOOP_MAX_ITER=50            # default: 50
  LINOLOOP_RUNNER=ralph           # default: ralph (open-ralph-wiggum)

Notes:
  - If the runner is not available, LinoLoop will print the executor brief and exit.
  - This script does not manage worktrees/branches yet; it expects your usual git discipline.
USAGE
}

ok() { printf "✓ %s\n" "$1"; }
warn() { printf "⚠ %s\n" "$1"; }
fail() { printf "✗ %s\n" "$1" >&2; }

need() {
  command -v "$1" >/dev/null 2>&1 || return 1
}

resolve_linotype() {
  if [ -x "$ROOT_DIR/cli/linotype" ]; then
    LINOTYPE="$ROOT_DIR/cli/linotype"
    return 0
  fi
  if [ -x "$ROOT_DIR/cli/linotype.sh" ]; then
    LINOTYPE="$ROOT_DIR/cli/linotype.sh"
    return 0
  fi
  return 1
}

ensure_dirs() {
  mkdir -p "$LOCK_DIR" "$LOG_DIR"
}

lock_acquire() {
  local name="$1"
  local lf="$LOCK_DIR/$name.lock"
  if [ -f "$lf" ]; then
    fail "Lock exists: $lf"
    fail "Another run may be active or a previous run crashed. Delete the lock if safe."
    exit 1
  fi
  printf "%s\n" "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" > "$lf"
}

lock_release() {
  local name="$1"
  rm -f "$LOCK_DIR/$name.lock" || true
}

is_release() {
  local target="$1"
  [ -d "$RELEASES_DIR/$target" ] && [ -f "$RELEASES_DIR/$target/galleys.txt" ]
}

read_release_galleys() {
  local release="$1"
  local f="$RELEASES_DIR/$release/galleys.txt"
  awk '
    BEGIN { }
    /^[[:space:]]*#/ { next }
    /^[[:space:]]*$/ { next }
    { gsub(/\r$/, ""); print $0 }
  ' "$f"
}

run_one_galley() {
  local galley="$1"
  local run_id="$2"

  if [ -z "$LINOTYPE" ]; then
    fail "Linotype CLI not found. Tried:"
    fail "  - $ROOT_DIR/cli/linotype"
    fail "  - $ROOT_DIR/cli/linotype.sh"
    exit 1
  fi

  # Generate executor brief (authoritative "what to do" prompt)
  local brief
  if ! brief="$("$LINOTYPE" exec "$AGENT" "$galley")"; then
    fail "Failed to generate executor brief for galley: $galley"
    exit 1
  fi

  local log="$LOG_DIR/${run_id}__${galley}.log"

  # If a loop runner exists (open-ralph-wiggum), use it.
  if need "$RUNNER"; then
    ok "Running $galley via $RUNNER (agent=$AGENT, max_iter=$MAX_ITER)"
    # shellcheck disable=SC2086
    "$RUNNER" "$brief" --agent "$AGENT" --max-iterations "$MAX_ITER" | tee "$log"
    ok "Log: $log"
  else
    warn "Runner '$RUNNER' not found. Printing executor brief for manual use."
    printf "%s\n" "$brief"
    warn "Install open-ralph-wiggum (provides 'ralph') or set LINOLOOP_RUNNER to your loop runner."
    exit 2
  fi
}

main() {
  local target="${1:-}"
  if [ -z "$target" ] || [ "$target" = "-h" ] || [ "$target" = "--help" ]; then
    usage
    exit 0
  fi

  ensure_dirs

  if ! resolve_linotype; then
    fail "Could not resolve linotype CLI executable"
    exit 1
  fi

  local run_id
  run_id="$(date +%Y%m%d-%H%M%S)"

  lock_acquire "$target"
  trap 'lock_release "$target"' EXIT

  if is_release "$target"; then
    ok "Target is release: $target"
    local g
    while IFS= read -r g; do
      ok "Release step: $g"
      run_one_galley "$g" "$run_id"
    done < <(read_release_galleys "$target")
    ok "Release complete: $target"
  else
    ok "Target is galley: $target"
    run_one_galley "$target" "$run_id"
    ok "Galley complete (runner signalled completion): $target"
  fi
}

main "$@"
